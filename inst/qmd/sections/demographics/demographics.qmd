
<!-- KU ADRC DS COHORT -->

```{r extract person information from kuadrc cohort used for other parts of the report}
#| echo: false
#| eval: !expr (any(params[grepl("kuadrc", names(params))] == TRUE))

intake <- BRIDGE21::get_database_values(
  subject_fname,
  subject_lname,
  subject_birthdate,
  data = data,
  event_name = redcap_event_name
)

intake$subject_birthdate <- as.Date(
  intake$subject_birthdate,
  tryFormats = c("%Y-%m-%d", "%m/%d/%y", "%m/%d/%Y")
)

date <- c("visitmo", "visitday", "visityr")
date_expr <- rlang::expr(visitmo / visitday / visityr)

visit <- BRIDGE21::get_database_values(
  !!!date,
  sex,
  final_impression,
  data = data,
  event_name = redcap_event_name
)

visit <- BRIDGE21::format_date(visit, !!date_expr)

visit$age_at_visit <-
  visit$Date %>%
  as.Date(format = "%m/%d/%Y") %>%
  {
    as.numeric((. - intake$subject_birthdate) / 365.25)
  } %>%
  floor()

```


```{r display person information in a table format for kuadrc cohort}
#| echo: false
#| eval: !expr params$kuadrc_demographics
#| results: asis

BRIDGE21::format_quarto("SUMMARY OF YOUR STUDY VISIT", type = "section")

BRIDGE21::format_quarto("Physician Assessment and Note", type = "subsection")

BRIDGE21::format_quarto(
  BRIDGE21::add_string(
    "Each time you are seen, we have a team of clinicians review " +
      "your cognitive assessments, questionnaires your study partner answered, and clinical information. " +
      "Below is the clinicianâ€™s feedback from your last visit. "
  ),
  type = "strwrap"
)

name <- BRIDGE21::add_string(
  "Name: " + intake$subject_fname + " " + intake$subject_lname
)
lastvisit <- BRIDGE21::add_string(
  "Last Visit: " + tail(visit$Date, 1)
)

age <- BRIDGE21::add_string("Age: " + max(visit$age_at_visit) + " Years")

subjinfo_df <- data.frame(col1 = c(name, lastvisit), col2 = c(age, ""))

flextable::flextable(subjinfo_df) %>%
  flextable::width(j = 1, width = 4) %>%
  flextable::width(j = 2, width = 2.75) %>%
  flextable::delete_part(part = "header") %>%
  flextable::border_remove() %>%
  flextable::fontsize(j = 1:2, size = 11) %>%
  flextable::add_footer_row(
    values = visit$final_impression[length(visit$final_impression)],
    colwidths = 2
  )

BRIDGE21::format_quarto(type = "newpage")

```


<!-- BOLD STUDY -->

```{r extract person information from bold study used for other parts of the report}
#| echo: false
#| eval: !expr (any(params[grepl("bold", names(params))] == TRUE))

intake <- BRIDGE21::get_database_values(
  firstname,
  lastname,
  scrn_dob,
  sex,
  data = data,
  event_name = redcap_event_name
)

intake$scrn_dob <- as.Date(
  intake$scrn_dob,
  tryFormats = c("%Y-%m-%d", "%m/%d/%y", "%m/%d/%Y")
)

date <- date_expr <- "visitdt"

visit <- BRIDGE21::get_database_values(
  !!date,
  data = data,
  event_name = redcap_event_name
)


visit$formatted_date_of_visit <- BRIDGE21::format_date(visit, visitdt)[["Date"]]

visit$age_at_visit <- floor(
  as.numeric(visit$visitdt - intake$scrn_dob) / 365.25
)

```
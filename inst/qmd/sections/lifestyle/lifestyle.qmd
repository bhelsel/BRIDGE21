---
editor_options: 
  chunk_output_type: console
---

```{r controller to determine what lifestyle sections would have data for the kuadrc cohort or bold study}
#| echo: false
#| results: asis
#| eval: !expr (params$kuadrc_lifestyle) | (params$bold_lifestyle) | (params$abcds_lifestyle) | (params$trcds_lifestyle)

BRIDGE21::format_quarto("LIFESTYLE AND DISEASE RISK", type = "section")

BRIDGE21::format_quarto(
  BRIDGE21::add_string(
    "We assessed various measures that can affect your overall brain health. " +
      "Recent research suggests that a healthy lifestyle is a key components of brain health."
  ),
  type = "strwrap"
)

# Blood Pressure

blood_pressure <-
  BRIDGE21::get_database_values(
    "bpsys|bpsysl1|vsbpsys",
    "bpdias|bpdiasl1|bpdia|vsbpdia",
    date = date,
    data = data
  )

if (BRIDGE21::check_missing_values(blood_pressure, date)) {
  params$kuadrc_blood_pressure <- params$bold_blood_pressure <- params$abcds_blood_pressure <- params$trcds_blood_pressure <- FALSE
}

# Physical Activity

if (!is.null(params$accelres)) {
  accel_df <- tryCatch(
    {
      accelMetaDir <- file.path(params$accelres, "output_data", "meta")
      accelResDir <- file.path(params$accelres, "output_data", "results")
      dayMMFile <- list.files(accelResDir, "day.*MM", full.names = TRUE)
      BRIDGE21:::retrieve_accel_summary(
        readr::read_csv(
          dayMMFile,
          show_col_types = FALSE
        )
      )
    },
    error = function(e) {
      params$kuadrc_activity <<- params$bold_activity <<- params$abcds_activity <<- FALSE
      return(NULL)
    }
  )
} else {
  params$kuadrc_activity <- params$bold_activity <- params$abcds_activity <- FALSE
}

# Body Mass Index

anthrovars <- c(
  "weight|average_weight|wt|vsweight",
  "height|average_height|ht|vsheight"
)

anthro <- BRIDGE21::get_database_values(
  !!!anthrovars,
  date = date,
  data = data
)

check_missing_wt_ht <- function(wt, ht) {
  len <- c(wt = sum(!is.na(wt)), ht = sum(!is.na(ht)))
  if (len[["wt"]] > len[["ht"]] & len[["ht"]] == 1) {
    anthro[["height"]] <<- anthro[!is.na(anthro$height), "height", drop = TRUE]
    len[["ht"]] <- len["wt"]
  }
  noWtHt <- (len[["wt"]] == 0 | len[["ht"]] == 0) | len[["wt"]] != len[["ht"]]
  return(data.frame(lenWt = len[["wt"]], lenHt = len[["ht"]], noWtHt))
}

bmiCheck <- check_missing_wt_ht(
  wt = anthro[["weight"]],
  ht = anthro[["height"]]
)

if (bmiCheck[["noWtHt"]]) {
  params$kuadrc_bmi <- params$bold_bmi <- params$abcds_bmi <- params$trcds_bmi <- FALSE
}

# DXA Scan

if (params$kuadrc_dxa | params$bold_dxa) {
  dxaNames <- dxaVars <- c("mass", "lean", "fat", "total_fat", "dxa_bmd_z")

  if (params$bold_dxa) {
    dxaVars <- c(
      "dxa_total_kg",
      "dxa_lean_g",
      "dxa_fat_g",
      "dxa_fat_percent",
      "dxa_bmd_z"
    )
  }

  dxa <- BRIDGE21::get_database_values(!!!dxaVars, date = date, data = data)

  dxa <- dxa[apply(dxa[dxaVars], 1, FUN = function(x) all(!is.na(x))), ]

  if (BRIDGE21::check_missing_values(dxa, date)) {
    params$kuadrc_dxa <- params$bold_dxa <- FALSE
  }
}

```


{{< include sections/lifestyle/components/bp.qmd >}}

{{< include sections/lifestyle/components/activity.qmd >}}

{{< include sections/lifestyle/components/bmi.qmd >}}

{{< include sections/lifestyle/components/dxa.qmd >}}

{{< include sections/lifestyle/components/veggiemeter.qmd >}}


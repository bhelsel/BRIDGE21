```{r display body mass index table and plot for the kuadrc cohort and bold study}
#| echo: false
#| results: asis
#| fig-align: center
#| ft.align: center
#| eval: !expr (params$kuadrc_bmi) | (params$bold_bmi)

anthro_units <- ifelse(params$kuadrc_bmi, "imperial", "metric")

anthro <- BRIDGE21::calculate_bmi(anthro, weight, height, units = anthro_units)

ltex <- paste(
  readLines("sections/lifestyle/latex/bmi.tex"),
  collapse = "\n"
)


ltex <- glue::glue(
  ltex,
  bmiLast = round(anthro[[bmiCheck$lenWt, "bmi"]], 1),
  .open = "{{",
  .close = "}}"
)

cat(paste0("", ltex, ""), sep = "\n")

bmi_plot <- BRIDGE21::generate_bmi_arch_plot(
  anthro[[bmiCheck$lenWt, 2]],
  anthro[[bmiCheck$lenHt, 3]]
)

# Adjust alignment on Quarto ouput
bmi_plot <- bmi_plot +
  ggplot2::theme(plot.margin = ggplot2::margin(t = -40, r = -45))

ggplot2::ggsave(
  filename = "bmi_plot.png",
  bmi_plot,
  width = 6,
  height = 3,
  dpi = 300
)

weight_plot <- BRIDGE21::generate_weight_bar_plot(
  anthro[[bmiCheck$lenWt, 2]],
  anthro[[bmiCheck$lenHt, 3]]
)

ggplot2::ggsave(
  filename = "weight_plot.png",
  weight_plot,
  width = 8,
  height = 2,
  dpi = 300
)

paste("", "![](bmi_plot.png)", "\n\n", "![](weight_plot.png)") |>
  cat(sep = "\n")

# Add weight history table
anthro %>%
  BRIDGE21::format_date(!!date) %>%
  dplyr::select(Date, weight, bmi) %>%
  flextable::flextable() %>%
  flextable::set_header_labels(
    Date = "Date",
    weight = "Weight (lbs)",
    bmi = "BMI (kg/mÂ²)"
  ) %>%
  flextable::add_header_row(values = "Weight History", colwidths = 3) %>%
  flextable::bold(i = 1, part = "header") %>%
  flextable::width(j = 1:3, width = 2) %>%
  flextable::align(j = 1:3, part = "all", align = "center") %>%
  flextable::add_footer_row(
    values = "BMI: Body Mass Index calculated from weight and height measurements.",
    colwidths = 3
  )

BRIDGE21::format_quarto(type = "newpage")

```